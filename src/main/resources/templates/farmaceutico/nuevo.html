<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/layoutFarmaceutico :: layoutBase(~{::section})}">

<section th:fragment="contenido">

	<div class="container mt-4">

		<form th:action="@{/orden/registrar}" method="post" th:object="${orden}">
		    <div class="row mb-3 mt-5 align-items-center text-white">
		        <div class="col-md-10">
		            <h1 class="m-0">
		                <i class="fa-solid fa-file-circle-plus me-2"></i>
		                Emisión de Orden de Compra
		            </h1>
		        </div>

		        <div class="col-md-2">
		            <button type="submit" class="btn btn-primary w-100">
		                <i class="fa-solid fa-floppy-disk me-2"></i>
		                Registrar
		            </button>
		        </div>
		    </div>

		    <div class="card mb-4 bg-dark text-white">
		        <div class="card-body">
		            <p class="m-0">
		                <strong><i class="fa-solid fa-calendar-day me-2"></i>Fecha:</strong>
		                <span th:text="${#dates.format(#dates.createNow(), 'dd/MM/yyyy')}"></span>
		            </p>
		        </div>
		    </div>
		</form>

		<!-- Sección de Selección de Productos -->
		<div class="card mb-4 bg-dark text-white">
		    <div class="card-body">

		        <!-- Botón para abrir el modal -->
		        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalProductos">
		            <i class="fa-solid fa-magnifying-glass me-2"></i> Seleccionar Medicamento
		        </button>

		        <!-- Medicamento Seleccionado -->
		        <form novalidate th:action="@{/orden/agregar}" method="post" th:object="${medicamentoSeleccionado}"
		            class="needs-validation">
		            <div class="row g-2 align-items-end">
		                <div class="col-md-2">
		                    <label class="form-label text-white">Código</label>
		                    <input type="text" class="form-control bg-dark text-white border-secondary"
		                        th:field="*{codProducto}" readonly
		                        th:classappend="${#fields.hasErrors('codProducto')} ? 'is-invalid' : ''">
		                </div>
		                <div class="col-md-4">
		                    <label class="form-label text-white">Nombre</label>
		                    <input type="text" class="form-control bg-dark text-white border-secondary"
		                        th:field="*{descripcion}" readonly
		                        th:classappend="${#fields.hasErrors('descripcion')} ? 'is-invalid' : ''">
		                </div>
		                <div class="col-md-2">
		                    <label class="form-label text-white">Precio</label>
		                    <input type="text" class="form-control bg-dark text-white border-secondary"
		                        th:field="*{precio}"
		                        th:classappend="${#fields.hasErrors('precio')} ? 'is-invalid' : ''">
		                </div>
		                <div class="col-md-2">
		                    <label class="form-label text-white">Cantidad</label>
		                    <input type="number" class="form-control bg-dark text-white border-secondary"
		                        th:field="*{cantidad}"
		                        th:classappend="${#fields.hasErrors('cantidad')} ? 'is-invalid' : ''">
		                </div>
		                <div class="col-md-2 d-grid">
		                    <button class="btn btn-success">
		                        <i class="fa-solid fa-plus me-2"></i> Agregar
		                    </button>
		                </div>
		            </div>
		        </form>
		    </div>
		</div>
		
		<!-- Detalle grilla -->

		<div class="card bg-dark text-white">
		    <div class="card-body">
		        <h5 class="text-white">
		            <i class="fa-solid fa-pills me-2"></i>Detalle de Medicamentos
		        </h5>
		        <div class="table-responsive">
		            <table class="table table-dark table-bordered align-middle text-white">
		                <thead>
		                    <tr>
		                        <th>Código</th>
		                        <th>Nombre</th>
		                        <th>Precio</th>
		                        <th>Cantidad</th>
		                        <th>Subtotal</th>
		                        <th>Acciones</th>
		                    </tr>
		                </thead>
		                <tbody>
		                    <tr th:each="item : ${seleccionados}">
		                        <td th:text="${item.codProducto}"></td>
		                        <td th:text="${item.descripcion}"></td>
		                        <td th:text="${item.precio}"></td>
		                        <td th:text="${item.cantidad}"></td>
		                        <td th:text="${item.subtotal}"></td>
		                        <td>
		                            <form th:action="@{/orden/quitar}" method="post">
		                                <input type="hidden" name="codigo" th:value="${item.codProducto}" />
		                                <button class="btn btn-danger btn-sm">
		                                    <i class="fa-solid fa-trash me-1"></i> Quitar
		                                </button>
		                            </form>
		                        </td>
		                    </tr>
		                </tbody>
		            </table>
		        </div>
		    </div>
		</div>

	<!-- Fragmento Modal de Selección de Productos -->
	<div th:replace="~{fragmentos/modal-productos :: modal-productos(${medicamentos}, 'modalProductos')}"></div>

	<th:block th:utext="${alert}"></th:block>

	<!-- Script con jQuery -->
	<script>
		$(document).ready(function () {

			// Evento para seleccionar medicamento
			$(document).on('click', '.btnSeleccionar', function () {
				let codigo = $(this).data('codigo');
				let nombre = $(this).data('descripcion');
				let precio = $(this).data('precio');

				$('#codProducto').val(codigo);
				$('#descripcion').val(nombre);
				$('#precio').val(precio);
				$('#cantidad').val(1);

				$('#modalProductos').modal('hide');
			});

			// Evento cuando se oculta el modal para limpiar backdrop
			$('#modalProductos').on('hidden.bs.modal', function () {
				$('.modal-backdrop').remove();     // Elimina fondo negro
				$('body').removeClass('modal-open'); // Restaura el scroll
			});
		});
	</script>
</section>

</html>